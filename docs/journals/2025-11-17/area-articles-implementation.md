# エリア記事システムの実装

2025年11月17日

ブランチ: feature/area-articles
コミット: ecc0722

## ユーザの要求

前回のセッションで実装したConform統合の続きとして、記事システムを完成させたい。記事がWebに表示されない問題の修正、記事生成ワークフローの確立、全エリアの記事作成、そして本番環境へのデプロイまでを完了させる。

## 実装の背景と意図

Tokyo Hyperlocalアプリケーションに、店舗リストだけでなくエリアガイド記事を追加することで、よりストーリー性のあるコンテンツを提供したいという要望があった。単なる店舗の羅列ではなく、エリアの雰囲気やシーンに合わせた文脈のある情報を届けることで、ユーザーの体験価値を高めることが目的である。

記事の生成にはAI（Claude API）を活用し、データベースから実際の店舗情報を取得してコンテンツに組み込む。これにより、常に最新の店舗データが記事内に反映され、手動メンテナンスの負担を軽減できる。

## 実装内容

### metadataフィールドのJSON処理問題の解決

管理画面で記事を保存する際、metadataフィールドがオブジェクトとして表示されるべきところが文字列化された状態で表示される問題が発生していた。これはParseJSONResultsPluginがデータベースから取得したJSONを自動的にパースする一方で、コード側でも再度JSON.parse()を呼んでいたことが原因だった。

解決策として、loaderからデータを返す際はオブジェクトのまま返し、テキストエリアに表示する時のみJSON.stringifyすることで、フォーム内での編集とデータベースへの保存の両方を正しく処理できるようにした。

### Web側での記事表示問題の調査と修正

記事を作成しても公開側のWebサイトに表示されない問題が発生した。調査の結果、loaderは正しく動作しており、データベースからも記事を取得できていることが確認できた。問題はブラウザ側のキャッシュにあった。

全てのルートファイルを調査したところ、5つのファイルでCache-Controlヘッダーが30日間のキャッシュを設定していた。これは本番環境では望ましいが、開発環境では記事を追加してもブラウザキャッシュが残り続けるため、リロードしても表示されないという状況を引き起こしていた。

修正として、NODE_ENV環境変数を使って開発環境ではmax-age=0、本番環境では4時間のキャッシュと24時間のstale-while-revalidateを設定するよう変更した。これにより、開発時は常に最新のデータが表示され、本番環境では適度なキャッシュによるパフォーマンス向上が両立できるようになった。

### 記事ページのナビゲーション改善

記事ページから元のエリアページに戻る手段がなく、ユーザーが迷子になる可能性があった。この問題を解決するため、パンくずナビゲーションと「他のガイド」セクションを追加した。

パンくずナビゲーションでは、現在のエリア名とシーン名を表示し、エリア名をクリックすることでエリアページに戻れるようにした。また、同じエリアの他のシーンの記事を表示する「他のガイド」セクションを追加することで、ユーザーが関連コンテンツを発見しやすくした。

記事本文の表示についても、当初はCardコンポーネントで囲んでいたが、記事という性質上、より意味的に正しいarticleタグを使用し、最大幅を設定することで読みやすさを向上させた。

### 記事生成ワークフローの確立

当初は管理画面のUIでAI生成ボタンを使って記事を作成していたが、この方法ではGit管理ができず、記事の履歴や再現性に課題があった。そこで、CLIツールを使ったワークフローに切り替えた。

CLIツールは、JSONファイルから記事データを読み込んでデータベースに登録する機能を持つ。これにより、Claude Codeで記事を執筆してJSONファイルとして保存し、コマンドラインから登録するという流れが確立できた。このワークフローの利点は、記事がファイルとして残るため履歴管理が容易になり、必要に応じて再登録や修正が簡単に行えることである。

さらに、Claude Code Skillsとして記事作成の手順を文書化し、エリアとシーンを指定して記事を作成する一連の流れを標準化した。

### 全エリアの記事作成

データベースから各エリアの高評価店舗を取得し、シーンに適した店舗を選定して記事を執筆した。記事はMarkdown形式で記述し、店舗データを埋め込むためにPlace IDを含むカスタムコンポーネントを使用した。これにより、記事内で店舗名や評価、営業時間などのデータが動的に表示される。

合計11記事を作成し、それぞれのエリアの特性とシーンに合わせた内容にした。渋谷では地元の人が通う隠れた名店、新宿では一人でも気兼ねなく入れる店、原宿では朝から訪れたいカフェというように、エリアごとの個性を活かしたストーリーを心がけた。

### 本番環境へのデプロイ準備

本番環境にデプロイするためには、まずTursoデータベースに新しいarea_articlesテーブルを作成し、ローカルで作成した記事データを同期する必要があった。

マイグレーションの適用はturso CLIを使ってSQLファイルを実行した。記事データの同期では、当初INSERT文のエクスポートでunistr関数が使われており、Tursoでサポートされていないためエラーが発生した。この問題は、SQLiteのquote関数を使って適切にエスケープされたINSERT文を生成することで解決した。

データベースの同期が完了した後、Tursoから最新のデータベースをダウンロードしてR2ストレージにアップロードした。Dockerビルド時にR2からデータベースをダウンロードして使用するため、この手順が必要である。

最後に、Fly.ioへのデプロイコマンドを実行した。ビルド時にR2_PUBLIC_URLを引数として渡し、データベースファイルを正しくダウンロードできるようにした。

## 技術的な学びと課題

今回の実装で最も時間を要したのは、キャッシュの挙動を理解し適切に制御することだった。ブラウザキャッシュは本番環境でのパフォーマンス向上には不可欠だが、開発環境では障害となる。環境変数による条件分岐は単純な解決策だが、効果的である。

JSONフィールドの扱いについても学びがあった。KyselyのParseJSONResultsPluginは便利だが、自動的な変換が行われることを理解していないと、二重パースや二重stringify化といった問題を引き起こす。データの流れを追い、どの時点で変換が行われるかを意識することが重要である。

データベース間のデータ移行では、SQL方言の違いに注意が必要だった。SQLiteで使える関数がTursoで使えないケースがあり、標準的なSQL機能を使うか、データベース固有の機能を避ける工夫が求められる。

記事生成ワークフローについては、UIとCLIのハイブリッドアプローチが有効だと感じた。初期の探索段階ではUIで試行錯誤し、ワークフローが確立したらCLIツールで自動化する。この段階的なアプローチにより、柔軟性と再現性の両立が可能になった。

## 今後の展開

多言語対応は次の重要なステップである。現在は日本語のみだが、データベース設計は既に多言語を想定しており、英語や中国語の記事を追加することで、より幅広いユーザーにリーチできる。

SEO最適化として、構造化データの追加やOpen Graphタグの実装を検討している。記事がソーシャルメディアでシェアされた際に適切な情報が表示されることは、コンテンツの拡散に重要である。

また、記事内で参照している店舗データの鮮度管理も課題である。店舗が閉店したり、評価が大きく変動した場合に、記事内容を自動的に更新または警告を出す仕組みがあれば、コンテンツの品質を維持できる。

ユーザー投稿機能も将来的な可能性として検討している。AI生成とユーザー投稿のハイブリッドモデルにより、より多様で豊富なコンテンツを提供できる可能性がある。
